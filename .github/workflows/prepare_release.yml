name: Prepare release

on:
  workflow_dispatch:
    inputs:
      release_name:
        description: 'Name for the release branch (e.g. v1.2.3)'
        required: true
        type: string

jobs:
  create-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: "release/latest"

      - name: Create release branch from release/latest
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          RELEASE_BRANCH="release/${{ github.event.inputs.release_name }}"

          # Ensure we have the latest branches
          git fetch origin release/latest

          # Create and push the new branch
          git checkout -b "$RELEASE_BRANCH" origin/release/latest
          git push origin "$RELEASE_BRANCH"

      - name: Create pull request
        uses: peter-evans/create-pull-request@v7
        with:
          base: "release/${{ github.event.inputs.release_name }}"
          branch: "main"
          title: "Merge release/latest into release/${{ github.event.inputs.release_name }}"
          body: "Release `${{ github.event.inputs.release_name }}` - template."
          draft: true